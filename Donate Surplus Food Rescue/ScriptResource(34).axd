// (c) 2010 CodePlex Foundation
(function(){function n(){Type.registerNamespace("Sys.Extended.UI");Sys.Extended.UI.CascadingDropDownSelectionChangedEventArgs=function(n,t){Sys.Extended.UI.CascadingDropDownSelectionChangedEventArgs.initializeBase(this);this._oldValue=n;this._newValue=t};Sys.Extended.UI.CascadingDropDownSelectionChangedEventArgs.prototype={get_oldValue:function(){return this._oldValue},get_newValue:function(){return this._newValue}};Sys.Extended.UI.CascadingDropDownSelectionChangedEventArgs.registerClass("Sys.Extended.UI.CascadingDropDownSelectionChangedEventArgs",Sys.EventArgs);Sys.Extended.UI.CascadingDropDownBehavior=function(n){Sys.Extended.UI.CascadingDropDownBehavior.initializeBase(this,[n]);this._parentControlID=null;this._category=null;this._promptText=null;this._loadingText=null;this._promptValue=null;this._emptyValue=null;this._emptyText=null;this._servicePath=location.pathname;this._serviceMethod=null;this._contextKey=null;this._useContextKey=!1;this._useHttpGet=!1;this._enableAtLoading=!1;this._parentElement=null;this._changeHandler=null;this._parentChangeHandler=null;this._lastParentValues=null;this._selectedValue=null;this._actualDisabledStatus=!1};Sys.Extended.UI.CascadingDropDownBehavior.prototype={initialize:function(){var n,t;Sys.Extended.UI.CascadingDropDownBehavior.callBaseMethod(this,"initialize");$common.prepareHiddenElementForATDeviceUpdate();n=this.get_element();this._actualDisabledStatus=n.disabled;this._clearItems();n.CascadingDropDownCategory=this._category;this._changeHandler=Function.createDelegate(this,this._onChange);$addHandler(n,"change",this._changeHandler);this._parentControlID&&(this._parentElement=$get(this._parentControlID),this._parentElement||Sys.Debug.fail(String.format(Sys.Extended.UI.Resources.CascadingDropDown_NoParentElement,this._parentControlID)),this._parentElement&&(n.CascadingDropDownParentControlID=this._parentControlID,this._parentChangeHandler=Function.createDelegate(this,this._onParentChange),$addHandler(this._parentElement,"change",this._parentChangeHandler),this._parentElement.childDropDown||(this._parentElement.childDropDown=[]),this._parentElement.childDropDown.push(this)));this._onParentChange(null,!0);t=this;setTimeout(function(){t._actualDisabledStatus&&(n.disabled=t._actualDisabledStatus)},50)},dispose:function(){var n=this.get_element();this._changeHandler&&($removeHandler(n,"change",this._changeHandler),this._changeHandler=null);this._parentChangeHandler&&(this._parentElement&&$removeHandler(this._parentElement,"change",this._parentChangeHandler),this._parentChangeHandler=null);Sys.Extended.UI.CascadingDropDownBehavior.callBaseMethod(this,"dispose")},_clearItems:function(){var n=this.get_element();if(n!=null&&n.options!=null)while(0<n.options.length)n.remove(0)},_isPopulated:function(){var n=this.get_element().options.length;return this._promptText?n>1:n>0},_setOptions:function(n,t,i){var r,s,h,o,f,e,u,v;if(this.get_isInitialized()){if(r=this.get_element(),this._clearItems(),h="",i&&this._loadingText?(s=this._loadingText,this._selectedValue&&(h=this._selectedValue)):!i&&n&&0==n.length&&null!=this._emptyText?(s=this._emptyText,this._emptyValue&&(h=this._emptyValue)):this._promptText&&(s=this._promptText,this._promptValue&&(h=this._promptValue)),s&&(o=new Option(s,h),r.options[r.options.length]=o),f=null,e=-1,n){for(u=0;u<n.length;u++){var c=n[u],y=c.name,l=c.value,a=c.optionTitle;c.isDefaultValue&&(this.set_SelectedValue(l,y,a),e=u,this._promptText&&e++);o=new Option(y,l);l==this._selectedValue&&(f=o);a&&o.setAttribute("title",a);r.options[r.options.length]=o}f&&(f.selected=!0)}if(f?this.set_SelectedValue(r.options[r.selectedIndex].value,r.options[r.selectedIndex].text):f||e==-1?t||f||i||this._promptText||!(r.options.length>0)?t||f||i||this.set_SelectedValue("",""):this.set_SelectedValue(r.options[0].value,r.options[0].text):(r.options[e].selected=!0,this.set_SelectedValue(r.options[e].value,r.options[e].text)),r.childDropDown&&!i)for(u=0;u<r.childDropDown.length;u++)r.childDropDown[u]._onParentChange();else n&&Sys.Browser.agent!==Sys.Browser.Safari&&Sys.Browser.agent!==Sys.Browser.Opera&&(document.createEvent?(v=document.createEvent("HTMLEvents"),v.initEvent("change",!0,!1),this.get_element().dispatchEvent(v)):document.createEventObject&&this.get_element().fireEvent("onchange"));this._enableAtLoading||((this._loadingText||this._promptText||this._emptyText)&&(r.disabled=!n||0==n.length),this._actualDisabledStatus&&(r.disabled=this._actualDisabledStatus));i&&this.raisePopulated(Sys.EventArgs.Empty)}},_onChange:function(){if(this._isPopulated()){var n=this.get_element();-1==n.selectedIndex||this._promptText&&0==n.selectedIndex?this.set_SelectedValue("",""):this.set_SelectedValue(n.options[n.selectedIndex].value,n.options[n.selectedIndex].text,n.options[n.selectedIndex].title)}},_onParentChange:function(n,t){for(var s=this.get_element(),i="",f=this._parentControlID,r,u,e,o;f;){if(r=$get(f),r&&-1!=r.selectedIndex&&(u=r.options[r.selectedIndex].value,u&&u!="")){i=r.CascadingDropDownCategory+":"+u+";"+i;f=r.CascadingDropDownParentControlID;continue}break}if(i==""||this._lastParentValues!=i){if(this._lastParentValues=i,i==""&&this._parentControlID){this._setOptions(null,t);return}if(this._setOptions(null,t,!0),this._servicePath&&this._serviceMethod){if(e=new Sys.CancelEventArgs,this.raisePopulating(e),e.get_cancel())return;o={knownCategoryValues:i,category:this._category};this._useContextKey&&(o.contextKey=this._contextKey);Sys.Net.WebServiceProxy.invoke(this._servicePath,this._serviceMethod,this._useHttpGet,o,Function.createDelegate(this,this._onMethodComplete),Function.createDelegate(this,this._onMethodError));$common.updateFormToRefreshATDeviceBuffer()}}},_onMethodComplete:function(n){this._setOptions(n)},_onMethodError:function(n){n.get_timedOut()?this._setOptions([this._makeNameValueObject(Sys.Extended.UI.Resources.CascadingDropDown_MethodTimeout)]):this._setOptions([this._makeNameValueObject(String.format(Sys.Extended.UI.Resources.CascadingDropDown_MethodError,n.get_statusCode()))])},_makeNameValueObject:function(n){return{name:n,value:n}},get_ParentControlID:function(){return this._parentControlID},set_ParentControlID:function(n){this._parentControlID!=n&&(this._parentControlID=n,this.raisePropertyChanged("ParentControlID"))},get_Category:function(){return this._category},set_Category:function(n){this._category!=n&&(this._category=n,this.raisePropertyChanged("Category"))},get_PromptText:function(){return this._promptText},set_PromptText:function(n){this._promptText!=n&&(this._promptText=n,this.raisePropertyChanged("PromptText"))},get_PromptValue:function(){return this._promptValue},set_PromptValue:function(n){this._promptValue!=n&&(this._promptValue=n,this.raisePropertyChanged("PromptValue"))},get_EmptyText:function(){return this._emptyText},set_EmptyText:function(n){this._emptyText!=n&&(this._emptyText=n,this.raisePropertyChanged("EmptyText"))},get_EmptyValue:function(){return this._emptyValue},set_EmptyValue:function(n){this._emptyValue!=n&&(this._emptyValue=n,this.raisePropertyChanged("EmptyValue"))},get_LoadingText:function(){return this._loadingText},set_LoadingText:function(n){this._loadingText!=n&&(this._loadingText=n,this.raisePropertyChanged("LoadingText"))},get_SelectedValue:function(){return this._selectedValue},set_SelectedValue:function(n,t,i){var r,u;this._selectedValue!=n&&(t||(r=n.indexOf(":::"),-1!=r&&(t=n.slice(r+3),n=n.slice(0,r),r=t.indexOf(":::"),-1!=r&&(i=t.slice(r+3),t=t.slice(0,r)))),u=this._selectedValue,this._selectedValue=n,this.raisePropertyChanged("SelectedValue"),this.raiseSelectionChanged(new Sys.Extended.UI.CascadingDropDownSelectionChangedEventArgs(u,n)));Sys.Extended.UI.CascadingDropDownBehavior.callBaseMethod(this,"set_ClientState",[this._selectedValue+":::"+t+":::"+(i?":::"+i:"")])},get_ServicePath:function(){return this._servicePath},set_ServicePath:function(n){this._servicePath!=n&&(this._servicePath=n,this.raisePropertyChanged("ServicePath"))},get_ServiceMethod:function(){return this._serviceMethod},set_ServiceMethod:function(n){this._serviceMethod!=n&&(this._serviceMethod=n,this.raisePropertyChanged("ServiceMethod"))},get_contextKey:function(){return this._contextKey},set_contextKey:function(n){this._contextKey!=n&&(this._contextKey=n,this.set_useContextKey(!0),this.raisePropertyChanged("contextKey"))},get_useContextKey:function(){return this._useContextKey},set_useContextKey:function(n){this._useContextKey!=n&&(this._useContextKey=n,this.raisePropertyChanged("useContextKey"))},get_useHttpGet:function(){return this._useHttpGet},set_useHttpGet:function(n){this._useHttpGet!=n&&(this._useHttpGet=n,this.raisePropertyChanged("useHttpGet"))},get_enableAtLoading:function(){return this._enableAtLoading},set_enableAtLoading:function(n){this._enableAtLoading!=n&&(this._enableAtLoading=n,this.raisePropertyChanged("enableAtLoading"))},add_selectionChanged:function(n){this.get_events().addHandler("selectionChanged",n)},remove_selectionChanged:function(n){this.get_events().removeHandler("selectionChanged",n)},raiseSelectionChanged:function(n){var t=this.get_events().getHandler("selectionChanged");t&&t(this,n)},add_populating:function(n){this.get_events().addHandler("populating",n)},remove_populating:function(n){this.get_events().removeHandler("populating",n)},raisePopulating:function(n){var t=this.get_events().getHandler("populating");t&&t(this,n)},add_populated:function(n){this.get_events().addHandler("populated",n)},remove_populated:function(n){this.get_events().removeHandler("populated",n)},raisePopulated:function(n){var t=this.get_events().getHandler("populated");t&&t(this,n)}};Sys.Extended.UI.CascadingDropDownBehavior.registerClass("Sys.Extended.UI.CascadingDropDownBehavior",Sys.Extended.UI.BehaviorBase);Sys.registerComponent(Sys.Extended.UI.CascadingDropDownBehavior,{name:"cascadingDropDown"})}window.Sys&&Sys.loader?Sys.loader.registerScript("ExtendedCascadingDropDown",["ExtendedBase","ExtendedCommon","WebServices"],n):n()})();